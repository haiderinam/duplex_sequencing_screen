---
title: "ABL_SM_CRISPR_Cut_Analyses"
author: "Haider Inam"
date: '2023-03-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))

library(stringr)
library(dplyr)
library(ggplot2)
library(plotly)
library(tictoc)
library(doParallel)
library(foreach)
library(RColorBrewer)
#Cleanup code for plotting
cleanup=theme_bw() +
  theme(plot.title = element_text(hjust=.5),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.background = element_blank(),
        # axis.line = element_line(color = "black"),
        axis.text = element_text(face="bold",color="black",size="11"),
        text=element_text(size=11,face="bold"),
        axis.title=element_text(face="bold",size="11"))
```





```{r}
source("code/variantcaller/add_l298l.R")
for(i in c(15:18)){
  sample=paste("sample",i,sep = "")
  # sample="sample1"
  
  input_df_nol298l=read.csv(paste("data/Consensus_Data/novogene_lane18/",sample,"/nol298l/duplex/variant_caller_outputs/variants_unique_ann.csv",sep=""))
  input_df_l298l=read.csv(paste("data/Consensus_Data/novogene_lane18/",sample,"/l298l/duplex/variant_caller_outputs/variants_unique_ann.csv",sep=""))
  
  output_df=add_l298l(input_df_nol298l,input_df_l298l)
  write.csv(output_df,
            paste("data/Consensus_Data/novogene_lane18/",sample,"/duplex/variant_caller_outputs/variants_unique_ann.csv",sep = ""))  
}

```


```{r}
# heatmap_plotting_function(output_df,242,321,"ct")
heatmap_plotting_function=function(df_forplot,resi_start,resi_end,fill_variable=ct){
  
  # output_df=read.csv("data/Consensus_Data/novogene_lane18/sample12/sscs/variant_caller_outputs/variants_unique_ann.csv")
  # df_forplot=output_df
  # fill_variable="ct"
  # resi_start=242
  # resi_end=321
  df_forplot$fill_variable=df_forplot[[fill_variable]]
  
  twist=read.csv("data/codon_table.csv",header = T)
  twist=twist%>%filter(Twist%in%T)
  
  df_forplot=df_forplot%>%filter(protein_start%in%c(resi_start:resi_end),
                                 alt_codon%in%twist$Codon,
                                 !consequence_terms%in%"stop_gained")
  
  df_grid  = expand.grid(protein_start = c(resi_start:resi_end),alt_aa = unique(df_forplot$alt_aa))
  df_forplot=merge(df_grid,df_forplot,by=c("protein_start","alt_aa"),all=T)
  
  ###Trying to add in the score as WT for residues that are wt
  reference_seq=read.table("data/Refs/ABL/abl_cds_translation.txt")
  df_forplot=df_forplot%>%
    rowwise()%>%
    # group_by(protein_start)%>%
    mutate(ref_aa=case_when(ref_aa%in%NA~substr(reference_seq,protein_start,protein_start),
                            T~ref_aa))%>%
    mutate(wt=case_when(ref_aa==alt_aa~T,
                        T~F))
  
  
  df_forplot$alt_aa=factor(df_forplot$alt_aa,levels=c("P","G","Y","W","F","V","L","I","A","T","S","Q","N","M","C","E","D","R","K","H"))
  
  output_ggplot=ggplot(df_forplot,aes(x=protein_start,y=alt_aa))+
    geom_tile(data=subset(df_forplot,!is.na(fill_variable)),aes(fill=fill_variable))+
    scale_fill_gradient2(low ="darkblue",mid="white", high ="red",name="Count")+
    geom_tile(data=subset(df_forplot,is.na(fill_variable)&wt%in%F),aes(color="white"),linetype = "solid",color="white", fill = "gray90", alpha = 0.8)+
    geom_tile(data=subset(df_forplot,is.na(fill_variable)&wt%in%T),aes(color="white"),linetype = "solid",color="white", fill = "yellow", alpha = 0.4)+
    theme(panel.background=element_rect(fill="white", colour="black"))+scale_x_continuous(name="Residue on the ABL Kinase",limits=c(resi_start,resi_end),expand=c(0,0))+
    ylab("Mutant Amino Acid")
  
  output_ggplot
}
```


```{r}

```

