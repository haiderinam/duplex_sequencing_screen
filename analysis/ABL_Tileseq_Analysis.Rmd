---
title: "ABL_Tileseq_Analysis"
author: "Haider Inam"
date: '2024-10-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
# rm(list=ls())

library(stringr)
library(dplyr)
library(ggplot2)
library(plotly)
library(tictoc)
library(doParallel)
library(foreach)
library(RColorBrewer)
library("ggrepel")
library(reshape2)
#Cleanup code for plotting
# cleanup=theme_bw() +
#   theme(plot.title = element_text(hjust=.5),
#         panel.grid.major = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.background = element_blank(),
#         # axis.line = element_line(color = "black"),
#         axis.text = element_text(face="bold",color="black",size="11"),
#         text=element_text(size=11,face="bold"),
#         axis.title=element_text(face="bold",size="11"))

```
For the density plots:
```{r}
library(viridisLite)
library("MASS")

theme_set(theme_bw(base_size = 16))

# Get density of points in 2 dimensions.
# @param x A numeric vector.
# @param y A numeric vector.
# @param n Create a square n by n grid to compute density.
# @return The density within each square.
get_density <- function(x, y, ...) {
  dens <- MASS::kde2d(x, y, ...)
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  ii <- cbind(ix, iy)
  return(dens$z[ii])
}

set.seed(1)
dat <- data.frame(
  x = c(
    rnorm(1e4, mean = 0, sd = 0.1),
    rnorm(1e3, mean = 0, sd = 0.1)
  ),
  y = c(
    rnorm(1e4, mean = 0, sd = 0.1),
    rnorm(1e3, mean = 0.1, sd = 0.2)
  )
)
```


Looking at the ABL Tileseq results generated by Marta

```{r}
rm(list=ls())
data=read.csv("output/ABLEnrichmentScreens/ABL_Region1234_Tileseq/full_kinase_high_imatinib_tileseq.csv")

get_density <- function(x, y, ...) {
  dens <- MASS::kde2d(x, y, ...)
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  ii <- cbind(ix, iy)
  return(dens$z[ii])
}
library(viridis)
data=data%>%filter(!netgrowth_0_A%in%NA,!netgrowth_0_B%in%NA)
data$density <- get_density(data$netgrowth_0_A, data$netgrowth_0_B, n = 100)



ggplot(data%>%filter(is_intended%in%1))+
  geom_point(aes(netgrowth_0_A, netgrowth_0_B, color = density))+
  scale_color_viridis()


data=data%>%mutate(is_depleted=case_when(ct_D6_0_A == 0.5 & ct_D6_0_B == 0.5 ~ "Depleted_Both",
                                         ct_D6_0_A%in%0.5~"Depleted_RepA",
                                         ct_D6_0_B%in%0.5~"Depleted_RepB",
                                         T~"Not_Depleted"))
data$is_depleted=factor(data$is_depleted,levels=c("Not_Depleted","Depleted_RepA","Depleted_RepB","Depleted_Both"))
ggplot(data%>%filter(is_intended%in%1),aes(netgrowth_0_A, netgrowth_0_B))+
  geom_point(color="black",shape=21,aes(fill=is_depleted))+
  scale_fill_brewer(palette = "Set3")

ggplot(data%>%filter(is_intended%in%1),aes(netgrowth_0_A,fill=is_depleted))+
  geom_density(alpha=.5)+
  scale_fill_brewer(palette = "Set3")
source("code/resmuts_adder.R")
source("code/cosmic_data_adder.R")
source("code/plotting/cleanup.R")
data=resmuts_adder(data)
data=data%>%mutate(species=paste(ref_aa,protein_start,alt_aa,sep = ""))
data$is_intended=as.character(data$is_intended)
# data=cosmic_data_adder(data)
  

ggplot(data%>%filter(protein_start>=242,protein_start<=512,is_intended==1)%>%arrange(resmuts),aes(x=netgrowth_0_A,y=netgrowth_0_B))+
  geom_point(color="black",shape=21,aes(fill=factor(resmuts)))+
  # geom_text_repel(aes(label=ifelse(resmuts%in%T,species,"")))+
  geom_label_repel(size=2,aes(label=ifelse(resmuts%in%T,species,"")))+
  geom_abline(linetype="dashed")+
  scale_x_continuous(name="Net Growth Rate Rep A",limits=c(-.025,.075))+
  scale_y_continuous(name="Net Growth Rate Rep B",limits=c(-.025,.075))+
  labs(fill="Sanger\n Mutant")+
  scale_fill_manual(values=c("gray90","red"))+
  coord_equal()+
  cleanup+theme(legend.position = "none")

ggplot(data%>%filter(!protein_start%in%"359",is_intended%in%"1"),aes(x=netgrowth_0_A,fill=resmuts))+
  geom_density(alpha=.5)+
  scale_fill_manual(values=c("gray90","red"))

ggplot(data%>%filter(!protein_start%in%"359",is_intended%in%"1"),aes(x=netgrowth_0_A,fill=resmuts))+
  geom_density(alpha=.5)


ggplot(data,aes(x=netgrowth_0_A,fill=is_intended))+
  geom_density(alpha=.5)+
  facet_wrap(~type_0_A)+
  scale_fill_brewer(palette = "Set3")

plotly=ggplot(data,aes(x=ct_D6_0_A,fill=is_intended))+
  geom_density(alpha=.5)+
  facet_wrap(~type_0_A)+
  scale_fill_brewer(palette = "Set3")+
  scale_x_continuous(trans="log10")
ggplotly(plotly)



a=data%>%filter(type_0_A%in%"snp",is_intended%in%0)
a=data%>%filter(type_0_A%in%"snp",is_intended%in%0,ct_D6_0_A%in%0.5)


```
Making sure Marta's netgr calculations are accurate
```{r}
d0=read.csv("output/ABLEnrichmentScreens/ABL_Region1234_Tileseq/merged_table_BR1_D0_A_1_1_1_2.csv",header = T,stringsAsFactors = F)
d0=d0%>%mutate(MAF_D0=ct_D0/depth_D0)
d6=read.csv("output/ABLEnrichmentScreens/ABL_Region1234_Tileseq/merged_table_BR1_A_H_1_1_1_2.csv",header = T,stringsAsFactors = F)
d6=d6%>%mutate(MAF_D6=ct_D6/depth_D6)
d6=d6%>%dplyr::select(alt_start_pos,ref,alt,ct_D6,depth_D6,Density_D6,MAF_D6)

d0d6=merge(d0,d6,by = c("alt_start_pos","ref","alt"),all = T)
d0d6$Density_D6=as.numeric(d0d6$Density_D6)
d0d6=d0d6%>%mutate(depth_D6=case_when(depth_D6%in%NA~1863442,
                                    T~depth_D6),
                   ct_D6=case_when(ct_D6%in%NA~0.5,
                                    T~ct_D6),
                   Density_D6=case_when(Density_D6%in%NA~5775,
                                        T~Density_D6),
                   MAF_D6=ct_D6/depth_D6)
d0d6=d0d6%>%mutate(netgr=log((MAF_D6*Density_D6)/(MAF_D0*Density_D0))/deltat)
# d0d6=d0d6%>%mutate(netgr=log((MAF_D6*Density_D6)/(MAF_D0*Density_D0))/deltat,
#                    netgr=case_when(netgr%in%"-Inf"~0,
#                                    T~netgr))

ggplot(d0d6,aes(netgr))+geom_density()
ggplot(d0d6%>%filter(ct_D0>=50),aes(netgr))+geom_density()
a=d0d6%>%filter(ct_D0>=10)
d0d6_mt=read.csv("output/ABLEnrichmentScreens/ABL_Region1234_Tileseq/full_kinase_high_imatinib_tileseq.csv")
a=d0d6%>%filter(ct_D0>=50)
a_mt=d0d6_mt%>%filter(protein_start==250)

# ggplot(d0d6_mt%>%filter(),aes(netgrowth_mean))+geom_density()
```

