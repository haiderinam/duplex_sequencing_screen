---
title: "lane14_comparisons"
author: "Haider Inam"
date: '2022-10-24'
output: html_document
---

10.24.22
Analysis of Novogene Lane 14 Sequencing Data
The sequencing here was done on EGFR il3 indep and ABL il3 indep and imat, asc treated libraries
```{r setup, include=FALSE}
# rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
library(stringr)
library(dplyr)
library(ggplot2)
library(plotly)
library(tictoc)
library(doParallel)
library(foreach)
library(RColorBrewer)


#Cleanup code for plotting
cleanup=theme_bw() +
  theme(plot.title = element_text(hjust=.5),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text = element_text(face="bold",color="black",size="11"),
        text=element_text(size=11,face="bold"),
        axis.title=element_text(face="bold",size="11"))
```


```{r}
sample14=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample14_combined/variant_caller_outputs/duplex/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample14=sample14%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample14=sample14%>%mutate(maf=ct/depth)
sample14_simple=sample14%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

sample15=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample15/variant_caller_outputs/duplex/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample15=sample15%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample15=sample15%>%mutate(maf=ct/depth)
sample15_simple=sample15%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

sample16=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample16/variant_caller_outputs/duplex/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample16=sample16%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample16=sample16%>%mutate(maf=ct/depth)
sample16_simple=sample16%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

sample17=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample18/variant_caller_outputs/duplex/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample17=sample17%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample17=sample17%>%mutate(maf=ct/depth)
sample17_simple=sample17%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

sample18=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample18/variant_caller_outputs/duplex/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample18=sample18%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample18=sample18%>%mutate(maf=ct/depth)
sample18_simple=sample18%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

samples_14.16=merge(sample14_simple%>%filter(consequence_terms%in%"missense_variant"),sample16_simple%>%filter(consequence_terms%in%"missense_variant"),by=c("ref_aa","protein_start","alt_aa","ref","alt","alt_start_pos","consequence_terms"))

samples_14.16=samples_14.16%>%mutate(score=log2(maf.y/maf.x),score2=log2(ct.y/ct.x))
samples_14.16_simple=samples_14.16%>%dplyr::select(ref_aa,protein_start,alt_aa,consequence_terms,ct.x,score)

samples_14.18=merge(sample14_simple%>%filter(consequence_terms%in%"missense_variant"),sample18_simple%>%filter(consequence_terms%in%"missense_variant"),by=c("ref_aa","protein_start","alt_aa","ref","alt","alt_start_pos","consequence_terms"))

samples_14.18=samples_14.18%>%mutate(score=log2(maf.y/maf.x),score2=log2(ct.y/ct.x))
samples_14.18_simple=samples_14.18%>%dplyr::select(ref_aa,protein_start,alt_aa,consequence_terms,ct.x,score)

asc_scores=merge(samples_14.16_simple,samples_14.18_simple,by=c("ref_aa","protein_start","alt_aa","consequence_terms"))
a=asc_scores%>%filter(protein_start%in%c(337,464,465,468))

samples_14.17=merge(sample14_simple%>%filter(consequence_terms%in%"missense_variant"),sample17_simple%>%filter(consequence_terms%in%"missense_variant"),by=c("ref_aa","protein_start","alt_aa","ref","alt","alt_start_pos","consequence_terms"))
samples_14.17=samples_14.17%>%mutate(score=log2(maf.y/maf.x),score2=log2(ct.y/ct.x))
samples_14.17_simple=samples_14.17%>%dplyr::select(ref_aa,protein_start,alt_aa,consequence_terms,ct.x,score)

samples_14.15=merge(sample14_simple%>%filter(consequence_terms%in%"missense_variant"),sample15_simple%>%filter(consequence_terms%in%"missense_variant"),by=c("ref_aa","protein_start","alt_aa","ref","alt","alt_start_pos","consequence_terms"))
samples_14.15=samples_14.15%>%mutate(score=log2(maf.y/maf.x),score2=log2(ct.y/ct.x))
samples_14.15_simple=samples_14.15%>%dplyr::select(ref_aa,protein_start,alt_aa,consequence_terms,ct.x,score)

imat_scores=merge(samples_14.15_simple,samples_14.17_simple,by=c("ref_aa","protein_start","alt_aa","consequence_terms"))

ggplot(samples_14.16,aes(x=score))+geom_density()
ggplot(samples_14.16,aes(x=score))+geom_histogram(bins=100)

ggplot(imat_scores,aes(x=score.x,y=score.y))+geom_point()+geom_abline()
ggplot(imat_scores%>%mutate(name=paste(ref_aa,protein_start,alt_aa)),aes(x=score.x,y=score.y,label=name))+geom_text()
# ggplotly(plotly)
ggplot(imat_scores,aes(x=score.x,y=score.y))+geom_bin2d(bins=100)+scale_fill_continuous(type="viridis")+theme_bw()
ggplot(imat_scores,aes(x=score.x,y=score.y))+stat_density_2d(aes(fill=..level..),geom = "polygon", colour="white")+scale_fill_continuous(type="viridis")+theme_bw()+xlab("Enrichment Score Imat Treatment Replicate 1")+ylab("Enrichment Score Imat Treatment Replicate 2")

plotly=ggplot(imat_scores%>%filter(!alt_aa%in%c("PA","NY","LL"),protein_start>=242,protein_start<=492),aes(x=protein_start,y=alt_aa,fill=score.x))+geom_tile()+theme(panel.background=element_rect(fill="white", colour="white"))+scale_fill_gradient2(low ="blue",midpoint=0,mid="white", high ="red",name="Score")
ggplotly(plotly)
# cor(imat_scores$score.x,imat_scores$score.y,method="pearson")
# cor(asc_scores$score.x,asc_scores$score.y,method="pearson")




ggplot(asc_scores,aes(x=score.x,y=score.y))+geom_point()+geom_abline()
ggplot(asc_scores%>%mutate(name=paste(ref_aa,protein_start,alt_aa)),aes(x=score.x,y=score.y,label=name))+geom_text()
# ggplotly(plotly)
ggplot(asc_scores,aes(x=score.x,y=score.y))+geom_bin2d(bins=100)+scale_fill_continuous(type="viridis")+theme_bw()
ggplot(asc_scores,aes(x=score.x,y=score.y))+stat_density_2d(aes(fill=..level..),geom = "polygon", colour="white")+scale_fill_continuous(type="viridis")+theme_bw()+xlab("Enrichment Score Asciminib Treatment Replicate 1")+ylab("Enrichment Score Asciminib Treatment Replicate 2")

plotly=ggplot(asc_scores%>%filter(!alt_aa%in%c("PA","NY","LL"),protein_start>=242,protein_start<=492),aes(x=protein_start,y=alt_aa,fill=score.x))+geom_tile()+theme(panel.background=element_rect(fill="white", colour="white"))+scale_fill_gradient2(low ="blue",midpoint=0,mid="white", high ="red",name="Score")
ggplotly(plotly)

a=asc_scores

# a=samples_14.17%>%filter(ct.x>1)
```
```{r}

sample14=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample14_combined/sscs/variant_caller_outputs/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample14=sample14%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample14=sample14%>%mutate(maf=ct/depth)
sample14_simple=sample14%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)


sample1517=merge_samples("Novogene_lane14/sample15/sscs","Novogene_lane14/sample17/sscs")
sample1517=sample1517%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample1517=sample1517%>%mutate(maf=ct/depth)
sample1517_simple=sample1517%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)


samples_14.1517=merge(sample14_simple%>%filter(consequence_terms%in%"missense_variant"),sample1517_simple%>%filter(consequence_terms%in%"missense_variant"),by=c("ref_aa","protein_start","alt_aa","ref","alt","alt_start_pos","consequence_terms"))
samples_14.1517=samples_14.1517%>%mutate(score=log2(maf.y/maf.x),score2=log2(ct.y/ct.x))
samples_14.1517_simple=samples_14.1517%>%dplyr::select(ref_aa,protein_start,alt_aa,consequence_terms,ct.x,score)


samples_14.1517=samples_14.1517%>%mutate(resmuts=case_when(protein_start%in%253&alt_aa%in%"H"~T,
                                                         protein_start%in%255&alt_aa%in%"V"~T,
                                                         protein_start%in%486&alt_aa%in%"S"~T,
                                                         protein_start%in%396&alt_aa%in%"P"~T,
                                                         protein_start%in%255&alt_aa%in%"K"~T,
                                                         protein_start%in%315&alt_aa%in%"I"~T,
                                                         protein_start%in%252&alt_aa%in%"H"~T,
                                                         protein_start%in%253&alt_aa%in%"F"~T,
                                                         protein_start%in%250&alt_aa%in%"E"~T,
                                                         protein_start%in%359&alt_aa%in%"C"~T,
                                                         protein_start%in%351&alt_aa%in%"T"~T,
                                                         protein_start%in%355&alt_aa%in%"G"~T,
                                                         protein_start%in%317&alt_aa%in%"L"~T,
                                                         protein_start%in%359&alt_aa%in%"I"~T,
                                                         protein_start%in%355&alt_aa%in%"A"~T,
                                                         protein_start%in%459&alt_aa%in%"K"~T,
                                                         protein_start%in%276&alt_aa%in%"G"~T,
                                                         protein_start%in%299&alt_aa%in%"L"~T,
                                                         
                                                         T~F))

samples_14.1517=samples_14.1517%>%mutate(resresids=case_when(protein_start%in%253~T,
                                                         protein_start%in%255~T,
                                                         protein_start%in%486~T,
                                                         protein_start%in%396~T,
                                                         protein_start%in%255~T,
                                                         protein_start%in%315~T,
                                                         protein_start%in%252~T,
                                                         protein_start%in%253~T,
                                                         protein_start%in%250~T,
                                                         protein_start%in%359~T,
                                                         protein_start%in%351~T,
                                                         protein_start%in%355~T,
                                                         protein_start%in%317~T,
                                                         protein_start%in%359~T,
                                                         protein_start%in%355~T,
                                                         protein_start%in%459~T,
                                                         protein_start%in%276~T,
                                                         protein_start%in%299~T,
                                                         
                                                         T~F))

highscore=samples_14.1517%>%filter(!ct.x%in%1,protein_start>=242,protein_start<=494)
highscore=highscore%>%mutate(subs_name=paste(ref_aa,protein_start,alt_aa,sep = ""))
plotly=ggplot(highscore,aes(x=reorder(subs_name,-score),y=score,fill=resmuts))+geom_col()+theme(axis.text.x=element_text(angle=90, hjust=1))+scale_y_continuous(name="Enrithcment Score")+scale_x_discrete(name="Mutant")+guides(fill = guide_legend(title = "Clinically\n Observed \n Resmut"))
ggplotly(plotly)

ggplot(highscore%>%filter(resmuts%in%"TRUE"),aes(x=reorder(subs_name,-score),y=score))+geom_col()+theme_bw()

ic50data_all_sum=read.csv("output/ic50data_all_confidence_intervals_raw_data.csv",row.names = 1)
a=merge(highscore%>%filter(resmuts%in%"TRUE")%>%dplyr::select(subs_name,score),
        ic50data_all_sum%>%dplyr::select(species,netgr_pred_model,netgr_pred_mean),by.x="subs_name",by.y="species")
ggplot(a,aes(x=netgr_pred_mean,y=score,label=subs_name))+geom_text()+theme_bw()+xlab("IC50 Predicted Growth Rates")+ylab("Enrichment Score observed w 5k mutant library \n at 60k sscs at 2 days post 300nM Imatinib")+ggtitle("Imatinib Treatment on iL3 independent 384W library")
# ggplot(a,aes(x=netgr_pred_mean,y=netgr_pred_model,label=subs_name))+geom_text()
# aa=a%>%filter(!subs_name%in%"D276G")
# # cor(aa$score,aa$netgr_pred_mean)
# a=sample1517%>%filter(protein_start%in%"396")
# b=sample14%>%filter(protein_start%in%"396")

# ggplot(a%>%filter(!subs_name%in%"D276G"),aes(x=netgr_pred_mean,y=score,label=subs_name))+geom_point()+theme_bw()+xlab("IC50 Predicted Growth Rates")+ylab("Enrichment Score observed w 5k mutant library \n at 60k sscs")
# write.csv(highscore,"BCRABL_EnrichmentScores_iL3Independent_Library.csv")
```


Summing counts for the two samples for Asciminib and the two samples for imatinib to see if we can improve number of mutants seen in the dataset
```{r}

```

How uneven is the ABL library?
```{r}
sample14=sample14%>%mutate(region=case_when(protein_start<250&protein_start>=242~1,
                                              protein_start<258&protein_start>=250~2,
                                              protein_start<266&protein_start>=258~3,
                                              protein_start<274&protein_start>=266~4,
                                              protein_start<282&protein_start>=274~5,
                                              protein_start<290&protein_start>=282~6,
                                              protein_start<298&protein_start>=290~7,
                                              protein_start<306&protein_start>=298~8,
                                              protein_start<314&protein_start>=306~9,
                                              protein_start<322&protein_start>=314~10,
                                              protein_start<330&protein_start>=322~11,
                                              protein_start<338&protein_start>=330~12,
                                              protein_start<346&protein_start>=338~13,
                                              protein_start<354&protein_start>=346~14,
                                              protein_start<362&protein_start>=354~15,
                                              protein_start<370&protein_start>=362~16,
                                              protein_start<378&protein_start>=370~17,
                                              protein_start<386&protein_start>=378~18,
                                              protein_start<394&protein_start>=386~19,
                                              protein_start<402&protein_start>=394~20,
                                              protein_start<410&protein_start>=402~21,
                                              protein_start<418&protein_start>=410~22,
                                              protein_start<426&protein_start>=418~23,
                                              protein_start<434&protein_start>=426~24,
                                              protein_start<442&protein_start>=434~25,
                                              protein_start<450&protein_start>=442~26,
                                              protein_start<458&protein_start>=450~27,
                                              protein_start<466&protein_start>=458~28,
                                              protein_start<474&protein_start>=466~29,
                                              protein_start<482&protein_start>=474~30,
                                              protein_start<490&protein_start>=482~31,
                                              protein_start<498&protein_start>=490~32,
                                              T~0))
calls_sum=sample14%>%filter(consequence_terms%in%"missense_variant")%>%group_by(protein_start,region)%>%summarize(unique_mutants=n(),count=sum(ct))
ggplot(calls_sum%>%filter(protein_start>=242,protein_start<=500),aes(x=protein_start,y=count))+geom_col()+cleanup

getPalette = colorRampPalette(brewer.pal(33, "Set2"))

plotly=ggplot(calls_sum%>%filter(protein_start>=242,protein_start<=500),aes(x=protein_start,y=count))+geom_col(color="black",aes(fill=factor(region)))+cleanup+scale_fill_manual(values=getPalette(33))
ggplotly(plotly)


sample11=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample11/variant_caller_outputs/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample11=sample11%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample11=sample11%>%mutate(maf=ct/depth)

sample11=sample11%>%mutate(region=case_when(protein_start<250&protein_start>=242~1,
                                              protein_start<258&protein_start>=250~2,
                                              protein_start<266&protein_start>=258~3,
                                              protein_start<274&protein_start>=266~4,
                                              protein_start<282&protein_start>=274~5,
                                              protein_start<290&protein_start>=282~6,
                                              protein_start<298&protein_start>=290~7,
                                              protein_start<306&protein_start>=298~8,
                                              protein_start<314&protein_start>=306~9,
                                              protein_start<322&protein_start>=314~10,
                                              protein_start<330&protein_start>=322~11,
                                              protein_start<338&protein_start>=330~12,
                                              protein_start<346&protein_start>=338~13,
                                              protein_start<354&protein_start>=346~14,
                                              protein_start<362&protein_start>=354~15,
                                              protein_start<370&protein_start>=362~16,
                                              protein_start<378&protein_start>=370~17,
                                              protein_start<386&protein_start>=378~18,
                                              protein_start<394&protein_start>=386~19,
                                              protein_start<402&protein_start>=394~20,
                                              protein_start<410&protein_start>=402~21,
                                              protein_start<418&protein_start>=410~22,
                                              protein_start<426&protein_start>=418~23,
                                              protein_start<434&protein_start>=426~24,
                                              protein_start<442&protein_start>=434~25,
                                              protein_start<450&protein_start>=442~26,
                                              protein_start<458&protein_start>=450~27,
                                              protein_start<466&protein_start>=458~28,
                                              protein_start<474&protein_start>=466~29,
                                              protein_start<482&protein_start>=474~30,
                                              protein_start<490&protein_start>=482~31,
                                              protein_start<498&protein_start>=490~32,
                                              T~0))
calls_sum=sample11%>%filter(consequence_terms%in%"missense_variant")%>%group_by(protein_start,region)%>%summarize(unique_mutants=n(),count=sum(ct))

ggplot(calls_sum%>%filter(protein_start>=242,protein_start<=500),aes(x=protein_start,y=count))+geom_col()+cleanup
getPalette = colorRampPalette(brewer.pal(33, "Set2"))
plotly=ggplot(calls_sum%>%filter(protein_start>=242,protein_start<=500),aes(x=protein_start,y=count))+geom_col(color="black",aes(fill=factor(region)))+cleanup+scale_fill_manual(values=getPalette(33))
ggplotly(plotly)

ggplot(calls_sum%>%filter(protein_start>=242,protein_start<=500),aes(x=protein_start,y=count))+geom_col()+cleanup
plotly=ggplot(calls_sum%>%filter(protein_start>=242,protein_start<=500,!protein_start%in%c(411,417,455)),aes(x=protein_start,y=count))+geom_col(color="black",aes(fill=factor(region)))+cleanup+scale_fill_manual(values=getPalette(33))
ggplotly(plotly)
```
TSII Sample 11 and 12
```{r}
sample11=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample11/variant_caller_outputs/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample11=sample11%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample11=sample11%>%mutate(maf=ct/depth)
sample11_simple=sample11%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

sample12=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample12/variant_caller_outputs/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample12=sample12%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample12=sample12%>%mutate(maf=ct/depth)
sample12_simple=sample12%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

samples_11.12=merge(sample11_simple%>%filter(consequence_terms%in%"missense_variant"),sample12_simple%>%filter(consequence_terms%in%"missense_variant"),by=c("ref_aa","protein_start","alt_aa","ref","alt","alt_start_pos","consequence_terms"))

samples_11.12=samples_11.12%>%mutate(score=log2(maf.y/maf.x),score2=log2(ct.y/ct.x))
samples_11.12_simple=samples_11.12%>%dplyr::select(ref_aa,protein_start,alt_aa,consequence_terms,ct.x,score)


ggplot(samples_11.12,aes(x=score))+geom_density()
ggplot(samples_14.16,aes(x=score))+geom_histogram(bins=100)

samples_11.12=samples_11.12%>%mutate(resmuts=case_when(protein_start%in%253&alt_aa%in%"H"~T,
                                                         protein_start%in%255&alt_aa%in%"V"~T,
                                                         protein_start%in%486&alt_aa%in%"S"~T,
                                                         protein_start%in%396&alt_aa%in%"P"~T,
                                                         protein_start%in%255&alt_aa%in%"K"~T,
                                                         protein_start%in%315&alt_aa%in%"I"~T,
                                                         protein_start%in%252&alt_aa%in%"H"~T,
                                                         protein_start%in%253&alt_aa%in%"F"~T,
                                                         protein_start%in%250&alt_aa%in%"E"~T,
                                                         protein_start%in%359&alt_aa%in%"C"~T,
                                                         protein_start%in%351&alt_aa%in%"T"~T,
                                                         protein_start%in%355&alt_aa%in%"G"~T,
                                                         protein_start%in%317&alt_aa%in%"L"~T,
                                                         protein_start%in%359&alt_aa%in%"I"~T,
                                                         protein_start%in%355&alt_aa%in%"A"~T,
                                                         protein_start%in%459&alt_aa%in%"K"~T,
                                                         protein_start%in%276&alt_aa%in%"G"~T,
                                                         protein_start%in%299&alt_aa%in%"L"~T,
                                                         
                                                         T~F))

samples_11.12=samples_11.12%>%mutate(resresids=case_when(protein_start%in%253~T,
                                                         protein_start%in%255~T,
                                                         protein_start%in%486~T,
                                                         protein_start%in%396~T,
                                                         protein_start%in%255~T,
                                                         protein_start%in%315~T,
                                                         protein_start%in%252~T,
                                                         protein_start%in%253~T,
                                                         protein_start%in%250~T,
                                                         protein_start%in%359~T,
                                                         protein_start%in%351~T,
                                                         protein_start%in%355~T,
                                                         protein_start%in%317~T,
                                                         protein_start%in%359~T,
                                                         protein_start%in%355~T,
                                                         protein_start%in%459~T,
                                                         protein_start%in%276~T,
                                                         protein_start%in%299~T,
                                                         
                                                         T~F))

highscore=samples_11.12%>%filter(!ct.x%in%1,protein_start>=242,protein_start<=494)
highscore=highscore%>%mutate(subs_name=paste(ref_aa,protein_start,alt_aa,sep = ""))
plotly=ggplot(highscore,aes(x=reorder(subs_name,-score),y=score,fill=resmuts))+geom_col()+theme(axis.text.x=element_text(angle=90, hjust=1))+scale_y_continuous(name="Enrithcment Score")+scale_x_discrete(name="Mutant")+guides(fill = guide_legend(title = "Clinically\n Observed \n Resmut"))
ggplotly(plotly)

plotly=ggplot(highscore%>%filter(ct.y>=2),aes(x=reorder(subs_name,-score),y=score,fill=resresids))+geom_col()+theme(axis.text.x=element_text(angle=90, hjust=1))+scale_y_continuous(name="Enrithcment Score")+scale_x_discrete(name="Mutant")+guides(fill = guide_legend(title = "Clinically\n Observed \n Resmut"))
ggplotly(plotly)

ggplot(samples_11.12%>%filter(!alt_aa%in%c("LL","PA"),protein_start>=242,protein_start<=494),aes(x=protein_start,y=alt_aa,fill=score))+geom_tile()+theme(panel.background=element_rect(fill="white", colour="white"))+scale_fill_gradient2(low ="blue",midpoint=0,mid="white", high ="red",name="Score")


  
# a=highscore%>%filter(protein_start%in%"255")

```

TSII Sample 10 and 12
```{r}
source("code/merge_samples.R")
sample10=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample10_combined/variant_caller_outputs/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample10=sample10%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample10=sample10%>%mutate(maf=ct/depth)
sample10_simple=sample10%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

sample12=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample12/variant_caller_outputs/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample12=sample12%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample12=sample12%>%mutate(maf=ct/depth)
sample12_simple=sample12%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

samples_10.12=merge(sample10_simple%>%filter(consequence_terms%in%"missense_variant"),sample12_simple%>%filter(consequence_terms%in%"missense_variant"),by=c("ref_aa","protein_start","alt_aa","ref","alt","alt_start_pos","consequence_terms"))

samples_10.12=samples_10.12%>%mutate(score=log2(maf.y/maf.x),score2=log2(ct.y/ct.x))
samples_10.12_simple=samples_10.12%>%dplyr::select(ref_aa,protein_start,alt_aa,consequence_terms,ct.x,score)


ggplot(samples_10.12,aes(x=score))+geom_density()
# ggplot(samples_14.16,aes(x=score))+geom_histogram(bins=100)

samples_10.12=samples_10.12%>%mutate(resmuts=case_when(protein_start%in%253&alt_aa%in%"H"~T,
                                                         protein_start%in%255&alt_aa%in%"V"~T,
                                                         protein_start%in%486&alt_aa%in%"S"~T,
                                                         protein_start%in%396&alt_aa%in%"P"~T,
                                                         protein_start%in%255&alt_aa%in%"K"~T,
                                                         protein_start%in%315&alt_aa%in%"I"~T,
                                                         protein_start%in%252&alt_aa%in%"H"~T,
                                                         protein_start%in%253&alt_aa%in%"F"~T,
                                                         protein_start%in%250&alt_aa%in%"E"~T,
                                                         protein_start%in%359&alt_aa%in%"C"~T,
                                                         protein_start%in%351&alt_aa%in%"T"~T,
                                                         protein_start%in%355&alt_aa%in%"G"~T,
                                                         protein_start%in%317&alt_aa%in%"L"~T,
                                                         protein_start%in%359&alt_aa%in%"I"~T,
                                                         protein_start%in%355&alt_aa%in%"A"~T,
                                                         protein_start%in%459&alt_aa%in%"K"~T,
                                                         protein_start%in%276&alt_aa%in%"G"~T,
                                                         protein_start%in%299&alt_aa%in%"L"~T,
                                                         
                                                         T~F))

samples_10.12=samples_10.12%>%mutate(resresids=case_when(protein_start%in%253~T,
                                                         protein_start%in%255~T,
                                                         protein_start%in%486~T,
                                                         protein_start%in%396~T,
                                                         protein_start%in%255~T,
                                                         protein_start%in%315~T,
                                                         protein_start%in%252~T,
                                                         protein_start%in%253~T,
                                                         protein_start%in%250~T,
                                                         protein_start%in%359~T,
                                                         protein_start%in%351~T,
                                                         protein_start%in%355~T,
                                                         protein_start%in%317~T,
                                                         protein_start%in%359~T,
                                                         protein_start%in%355~T,
                                                         protein_start%in%459~T,
                                                         protein_start%in%276~T,
                                                         protein_start%in%299~T,
                                                         
                                                         T~F))

highscore=samples_10.12%>%filter(!ct.x%in%1,protein_start>=242,protein_start<=494)
highscore=highscore%>%mutate(subs_name=paste(ref_aa,protein_start,alt_aa,sep = ""))
plotly=ggplot(highscore,aes(x=reorder(subs_name,-score),y=score,fill=resmuts))+geom_col()+theme(axis.text.x=element_text(angle=90, hjust=1))+scale_y_continuous(name="Enrithcment Score")+scale_x_discrete(name="Mutant")+guides(fill = guide_legend(title = "Clinically\n Observed \n Resmut"))
ggplotly(plotly)

plotly=ggplot(highscore%>%filter(ct.y>=2),aes(x=reorder(subs_name,-score),y=score,fill=resresids))+geom_col()+theme(axis.text.x=element_text(angle=90, hjust=1))+scale_y_continuous(name="Enrithcment Score")+scale_x_discrete(name="Mutant")+guides(fill = guide_legend(title = "Clinically\n Observed \n Resmut"))
ggplotly(plotly)

ggplot(samples_10.12%>%filter(!alt_aa%in%c("LL","PA"),protein_start>=242,protein_start<=494),aes(x=protein_start,y=alt_aa,fill=score))+geom_tile()+theme(panel.background=element_rect(fill="white", colour="white"))+scale_fill_gradient2(low ="blue",midpoint=0,mid="white", high ="red",name="Score")

ggplot(samples_10.12%>%filter(!alt_aa%in%c("LL","PA"),protein_start>=242,protein_start<=494),aes(x=protein_start,y=alt_aa,fill=score))+geom_tile()+theme(panel.background=element_rect(fill="white", colour="white"))+scale_fill_gradient2(low ="blue",midpoint=3,mid="white", high ="red",name="Score")


ggplot(highscore%>%filter(resmuts%in%"TRUE"),aes(x=reorder(subs_name,-score),y=score))+geom_col()+theme_bw()

ic50data_all_sum=read.csv("output/ic50data_all_confidence_intervals_raw_data.csv",row.names = 1)
a=merge(highscore%>%filter(resmuts%in%"TRUE")%>%dplyr::select(subs_name,score),
        ic50data_all_sum%>%dplyr::select(species,netgr_pred_model,netgr_pred_mean),by.x="subs_name",by.y="species")
ggplot(a,aes(x=netgr_pred_mean,y=score,label=subs_name))+geom_text()+theme_bw()+xlab("IC50 Predicted Growth Rates")+ylab("Enrichment Score observed w 5k mutant library \n at 30k sscs at 2 days post 300nM Imatinib")+ggtitle("Concurrent iL3 withdrawal + Imat Treatment")
  
# a=highscore%>%filter(protein_start%in%"255")
# sum(highscore$ct.y)

sample10_simple=sample10_simple%>%
  mutate(error_status=case_when(protein_start%in%c(1:241,495:700)~T,
         T~F))

plotly=ggplot(sample10_simple%>%
         filter(protein_start>=99,protein_start<=600)%>%
         mutate(mutant=paste(protein_start,alt_aa)),aes(x=protein_start,y=maf,color=error_status))+
  geom_col()+
  scale_color_manual(values = c("red","blue"))+
  theme_bw()+
  theme(legend.position = "none")
ggplotly(plotly)

plotly=ggplot(sample10_simple%>%
         filter(protein_start>=99,protein_start<=600,ct>=3)%>%
         mutate(mutant=paste(protein_start,alt_aa)),aes(x=protein_start,y=maf,fill=error_status))+
  geom_col()+
  # geom_col(position = "dodge")+
  scale_fill_manual(values = c("blue","red"))+
  theme_bw()+
  theme(legend.position = "none")
  # scale_y_continuous(trans="log10")
ggplotly(plotly)

plotly=ggplot(sample10_simple%>%
         filter(protein_start>=99,protein_start<=600,ct>=1)%>%
         mutate(mutant=paste(protein_start,alt_aa)),aes(x=protein_start,y=maf))+
  geom_bar(aes(fill=error_status),stat="sum")+
  scale_fill_manual(values = c("blue","red"))+
  theme_bw()+
  theme(legend.position = "none")
ggplotly(plotly)
#Things to do with the error rate plot:
#1. Look at sscs vs ngs vs dcs
#2. Combine two samples and see how that improves error rates
# setwd("../")
# samplex=read.csv("data/Consensus_Data/Novogene_lane14/sample10_combined/variant_caller_outputs/variants_unique_ann.csv",header=T,stringsAsFactors = F)
# sampley=read.csv("data/Consensus_Data/Novogene_lane14/sample11/variant_caller_outputs/variants_unique_ann.csv",header=T,stringsAsFactors = F)
#   samples_xy=merge(samplex,sampley,by=c("type",
#                                         "alt_start_pos",
#                                         "alt_end_pos",
#                                         "ref",
#                                         "alt",
#                                         "protein_start",
#                                         "protein_end",
#                                         "amino_acids",
#                                         "codons",
#                                         "impact",
#                                         "polyphen_prediction",
#                                         "consequence_terms"),all = T)

lane14sortedsamples=merge_samples("Novogene_lane14/sample10_combined","Novogene_lane14/sample11")
lane14sortedsamples=lane14sortedsamples%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
lane14sortedsamples=lane14sortedsamples%>%mutate(maf=ct/depth)
lane14sorted_simple=lane14sortedsamples%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)
lane14sorted_simple=lane14sorted_simple%>%
  mutate(error_status=case_when(protein_start%in%c(1:241,495:700)~T,
         T~F))
plotly=ggplot(lane14sorted_simple%>%
         filter(protein_start>=99,protein_start<=600,ct>=3)%>%
         mutate(mutant=paste(protein_start,alt_aa)),aes(x=protein_start,y=maf))+
  geom_bar(aes(fill=error_status),stat="sum")+
  scale_fill_manual(values = c("blue","red"))+
  theme_bw()+
  theme(legend.position = "none")
ggplotly(plotly)

# library(ggplot2)

a=highscore%>%filter(resmuts%in%"TRUE")
```
Now I'm going to look at how much reduction in error rates we get with duplex sequencing
```{r}
sample10_duplex=read.csv(file = "data/Consensus_Data/Novogene_lane14/sample10_combined/variant_caller_outputs/duplex/variants_unique_ann.csv",header=T,stringsAsFactors = F)

sample10_duplex=sample10_duplex%>%
  rowwise()%>%
  mutate(ref_aa=strsplit(amino_acids,"/")[[1]][1],
         alt_aa=strsplit(amino_acids,"/")[[1]][2])
sample10_duplex=sample10_duplex%>%mutate(maf=ct/depth)
sample10_duplex_simple=sample10_duplex%>%dplyr::select(alt_start_pos,protein_start,ref,alt,ref_aa,alt_aa,consequence_terms,ct,depth,maf)

sample10_duplex_simple=sample10_duplex_simple%>%
  mutate(error_status=case_when(protein_start%in%c(1:241,495:700)~T,
         T~F))

plotly=ggplot(sample10_duplex_simple%>%
         filter(protein_start>=99,protein_start<=600)%>%
         mutate(mutant=paste(protein_start,alt_aa)),aes(x=protein_start,y=maf,color=error_status))+
  geom_col()+
  scale_color_manual(values = c("red","blue"))+
  theme_bw()+
  theme(legend.position = "none")
ggplotly(plotly)

plotly=ggplot(sample10_duplex_simple%>%
         filter(protein_start>=99,protein_start<=600,ct>=3)%>%
         mutate(mutant=paste(protein_start,alt_aa)),aes(x=protein_start,y=maf,color=error_status))+
  geom_col()+
  scale_color_manual(values = c("red","blue"))+
  theme_bw()+
  theme(legend.position = "none")
ggplotly(plotly)
```

